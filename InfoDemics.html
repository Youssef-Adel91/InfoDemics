<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfoDemics - Misinformation Spread Simulator</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/vis-network@9.1.6/dist/vis-network.min.js"></script>
    <link href="https://unpkg.com/vis-network@9.1.6/dist/dist/vis-network.min.css" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #FF4B4B 0%, #C62828 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 0;
            min-height: 800px;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 30px;
            border-right: 1px solid #dee2e6;
        }

        .sidebar h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }

        .control-group input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #d3d3d3;
            outline: none;
            -webkit-appearance: none;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #FF4B4B;
            cursor: pointer;
        }

        .value-display {
            display: inline-block;
            background: #FF4B4B;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
            margin-left: 10px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .run-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #FF4B4B 0%, #C62828 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }

        .run-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 75, 75, 0.3);
        }

        .run-button:active {
            transform: translateY(0);
        }

        .stats-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .stats-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .content-area {
            padding: 30px;
        }

        .visualization-grid {
            display: grid;
            grid-template-rows: 500px 400px;
            gap: 30px;
        }

        #network {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #fafafa;
        }

        #chart {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
        }

        .legend {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.5em;
            color: #666;
        }

        .results-summary {
            background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .results-summary h3 {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü¶† InfoDemics</h1>
            <p>Interactive Misinformation Spread Visualization using SIR Models</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <h2>üéõÔ∏è Controls</h2>

                <div class="control-group">
                    <label>
                        Œ≤ (Infection Rate)
                        <span class="value-display" id="beta-value">0.30</span>
                    </label>
                    <input type="range" id="beta" min="0" max="100" value="30" step="5">
                </div>

                <div class="control-group">
                    <label>
                        Œ≥ (Recovery Rate)
                        <span class="value-display" id="gamma-value">0.10</span>
                    </label>
                    <input type="range" id="gamma" min="0" max="100" value="10" step="5">
                </div>

                <div class="control-group">
                    <label>
                        Initial Infected %
                        <span class="value-display" id="infected-value">50%</span>
                    </label>
                    <input type="range" id="initial-infected" min="0" max="100" value="50" step="5">
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="remove-spreaders">
                    <label for="remove-spreaders">üö´ Ban Top 1% Influencers</label>
                </div>

                <button class="run-button" onclick="runSimulation()">‚ñ∂Ô∏è Run Simulation</button>

                <div class="stats-card">
                    <h3>üìä Dataset Info</h3>
                    <div class="stat-item">
                        <span>Total Nodes:</span>
                        <strong id="total-nodes">-</strong>
                    </div>
                    <div class="stat-item">
                        <span>Total Edges:</span>
                        <strong id="total-edges">-</strong>
                    </div>
                    <div class="stat-item">
                        <span>Conspiracy:</span>
                        <strong id="conspiracy-count">-</strong>
                    </div>
                </div>

                <div id="results-card" style="display: none;">
                    <div class="results-summary">
                        <h3>üìà Results</h3>
                        <div class="stat-item" style="border-color: rgba(255,255,255,0.3); color: white;">
                            <span>Peak Infection:</span>
                            <strong id="peak-infection">-</strong>
                        </div>
                        <div class="stat-item" style="border-color: rgba(255,255,255,0.3); color: white;">
                            <span>At Time Step:</span>
                            <strong id="peak-time">-</strong>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-area">
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #1E88E5;"></div>
                        <span>Susceptible</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FF4B4B;"></div>
                        <span>Infected</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4CAF50;"></div>
                        <span>Recovered</span>
                    </div>
                </div>

                <div class="visualization-grid">
                    <div id="network"></div>
                    <div id="chart"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let nodesData = [];
        let edgesData = [];
        let network = null;
        let graphData = { nodes: [], edges: [] };

        // Update slider values
        document.getElementById('beta').addEventListener('input', (e) => {
            document.getElementById('beta-value').textContent = (e.target.value / 100).toFixed(2);
        });
        document.getElementById('gamma').addEventListener('input', (e) => {
            document.getElementById('gamma-value').textContent = (e.target.value / 100).toFixed(2);
        });
        document.getElementById('initial-infected').addEventListener('input', (e) => {
            document.getElementById('infected-value').textContent = e.target.value + '%';
        });

        // Load CSV data
        async function loadData() {
            try {
                const nodesResponse = await fetch('nodes.csv');
                const edgesResponse = await fetch('edges.csv');
                
                const nodesText = await nodesResponse.text();
                const edgesText = await edgesResponse.text();
                
                const nodesParsed = Papa.parse(nodesText, { header: true });
                const edgesParsed = Papa.parse(edgesText, { header: true });
                
                nodesData = nodesParsed.data.filter(row => row.id);
                edgesData = edgesParsed.data.filter(row => row.source && row.target);
                
                processData();
                createInitialNetwork();
                updateStats();
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading CSV files. Make sure nodes.csv and edges.csv are in the same folder as this HTML file.');
            }
        }

        function processData() {
            nodesData.forEach(node => {
                node.followers_count = parseInt(node.followers) || 0;
                node.category = node.label.includes('Non_Conspiracy') ? 'Non-Conspiracy' : 
                               node.label.includes('Conspiracy') ? 'Conspiracy' : 'Non-Conspiracy';
                
                // Calculate degree
                node.degree = edgesData.filter(e => 
                    e.source == node.id || e.target == node.id
                ).length;
            });
        }

        function createInitialNetwork() {
            const nodes = nodesData.map(node => ({
                id: node.id,
                label: node.id,
                color: node.category === 'Conspiracy' ? '#FF4B4B' : '#1E88E5',
                size: 10 + node.followers_count / 2,
                title: `ID: ${node.id}<br>Category: ${node.category}<br>Followers: ${node.followers_count}<br>Degree: ${node.degree}`
            }));

            const edges = edgesData.map(edge => ({
                from: edge.source,
                to: edge.target,
                color: { color: '#cccccc' }
            }));

            graphData = { nodes, edges };

            const container = document.getElementById('network');
            const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
            const options = {
                physics: {
                    barnesHut: {
                        gravitationalConstant: -8000,
                        centralGravity: 0.3,
                        springLength: 200,
                        springConstant: 0.001
                    }
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 100
                }
            };

            network = new vis.Network(container, data, options);
        }

        function updateStats() {
            document.getElementById('total-nodes').textContent = nodesData.length;
            document.getElementById('total-edges').textContent = edgesData.length;
            document.getElementById('conspiracy-count').textContent = 
                nodesData.filter(n => n.category === 'Conspiracy').length;
        }

        function runSimulation() {
            const beta = parseFloat(document.getElementById('beta').value) / 100;
            const gamma = parseFloat(document.getElementById('gamma').value) / 100;
            const initialInfectedPct = parseInt(document.getElementById('initial-infected').value);
            const removeSpreaders = document.getElementById('remove-spreaders').checked;

            let nodes = [...nodesData];
            
            // Remove super-spreaders if requested
            if (removeSpreaders) {
                nodes.sort((a, b) => b.degree - a.degree);
                const threshold = Math.ceil(nodes.length * 0.01);
                nodes = nodes.slice(threshold);
            }

            // Initialize states
            const states = {};
            const conspiracyNodes = nodes.filter(n => n.category === 'Conspiracy');
            const totalInfected = Math.floor(nodes.length * initialInfectedPct / 100);
            const additionalInfected = Math.max(0, totalInfected - conspiracyNodes.length);
            
            const susceptibleNodes = nodes.filter(n => n.category === 'Non-Conspiracy');
            const randomInfected = susceptibleNodes
                .sort(() => Math.random() - 0.5)
                .slice(0, additionalInfected);

            nodes.forEach(node => {
                if (conspiracyNodes.includes(node) || randomInfected.includes(node)) {
                    states[node.id] = 'I';
                } else {
                    states[node.id] = 'S';
                }
            });

            // Build adjacency list
            const adjacency = {};
            nodes.forEach(n => adjacency[n.id] = []);
            edgesData.forEach(edge => {
                if (adjacency[edge.source] && adjacency[edge.target]) {
                    adjacency[edge.source].push(edge.target);
                    adjacency[edge.target].push(edge.source);
                }
            });

            // Run simulation
            const history = { time: [], S: [], I: [], R: [] };
            
            for (let t = 0; t < 50; t++) {
                const counts = { S: 0, I: 0, R: 0 };
                Object.values(states).forEach(state => counts[state]++);
                
                history.time.push(t);
                history.S.push(counts.S);
                history.I.push(counts.I);
                history.R.push(counts.R);

                const newStates = { ...states };

                // Infections
                Object.keys(states).forEach(nodeId => {
                    if (states[nodeId] === 'S') {
                        const neighbors = adjacency[nodeId] || [];
                        const infectedNeighbors = neighbors.filter(n => states[n] === 'I');
                        if (infectedNeighbors.length > 0) {
                            const prob = 1 - Math.pow(1 - beta, infectedNeighbors.length);
                            if (Math.random() < prob) {
                                newStates[nodeId] = 'I';
                            }
                        }
                    }
                });

                // Recoveries
                Object.keys(states).forEach(nodeId => {
                    if (states[nodeId] === 'I' && Math.random() < gamma) {
                        newStates[nodeId] = 'R';
                    }
                });

                Object.assign(states, newStates);
            }

            // Update visualization
            updateNetwork(states);
            plotSIRCurves(history);
            showResults(history);
        }

        function updateNetwork(states) {
            const updatedNodes = graphData.nodes.map(node => ({
                ...node,
                color: states[node.id] === 'I' ? '#FF4B4B' :
                       states[node.id] === 'R' ? '#4CAF50' : '#1E88E5'
            }));

            network.setData({
                nodes: new vis.DataSet(updatedNodes),
                edges: new vis.DataSet(graphData.edges)
            });
        }

        function plotSIRCurves(history) {
            const trace1 = {
                x: history.time,
                y: history.S,
                mode: 'lines+markers',
                name: 'Susceptible',
                line: { color: '#1E88E5', width: 3 }
            };

            const trace2 = {
                x: history.time,
                y: history.I,
                mode: 'lines+markers',
                name: 'Infected',
                line: { color: '#FF4B4B', width: 3 }
            };

            const trace3 = {
                x: history.time,
                y: history.R,
                mode: 'lines+markers',
                name: 'Recovered',
                line: { color: '#4CAF50', width: 3 }
            };

            const layout = {
                title: 'SIR Model: Misinformation Spread Over Time',
                xaxis: { title: 'Time Steps' },
                yaxis: { title: 'Number of Nodes' },
                hovermode: 'x unified',
                height: 380
            };

            Plotly.newPlot('chart', [trace1, trace2, trace3], layout);
        }

        function showResults(history) {
            const peakInfected = Math.max(...history.I);
            const peakTime = history.I.indexOf(peakInfected);

            document.getElementById('peak-infection').textContent = peakInfected + ' nodes';
            document.getElementById('peak-time').textContent = peakTime;
            document.getElementById('results-card').style.display = 'block';
        }

        // Load data on page load
        window.addEventListener('load', loadData);
    </script>
</body>
</html>
